/**********************************************************************************************************************
 * Includes
 *********************************************************************************************************************/

#include "heap_api.h"
#include "cmsis_os2.h"

/**********************************************************************************************************************
 * Private definitions and macros
 *********************************************************************************************************************/

#define MUTEX_TIMEOUT 0U

/**********************************************************************************************************************
 * Private typedef
 *********************************************************************************************************************/
 
/**********************************************************************************************************************
 * Private constants
 *********************************************************************************************************************/

const static osMutexAttr_t g_heap_mutex_attributes = {
    .name = "Heap_mutex", 
    .attr_bits = osMutexRecursive | osMutexPrioInherit, 
    .cb_mem = NULL, 
    .cb_size = 0U
};

/**********************************************************************************************************************
 * Private variables
 *********************************************************************************************************************/

static osMutexId_t g_heap_mutex = NULL;

/**********************************************************************************************************************
 * Exported variables and references
 *********************************************************************************************************************/

/**********************************************************************************************************************
 * Prototypes of private functions
 *********************************************************************************************************************/

/**********************************************************************************************************************
 * Definitions of private functions
 *********************************************************************************************************************/

/**********************************************************************************************************************
 * Definitions of exported functions
 *********************************************************************************************************************/

bool Heap_API_Init (void) {
    if (g_heap_mutex == NULL) {
        g_heap_mutex = osMutexNew(&g_heap_mutex_attributes);
    }

    if (g_heap_mutex == NULL) {
        return false;
    }

    return true;
}

void* Heap_API_MemoryAllocate(const size_t number_of_elements, const size_t size) {
    if ((number_of_elements == 0) || (size == 0)) {
        return NULL;
    }

    if (g_heap_mutex == NULL) {
        return NULL;
    }
    
    if (osMutexAcquire(g_heap_mutex, MUTEX_TIMEOUT) != osOK) {
        return NULL;
    }

    void *allocated_memory = NULL;

    allocated_memory = calloc(number_of_elements, size);

    osMutexRelease(g_heap_mutex);

    return allocated_memory;
}

bool Heap_API_Free (void *pointer_to_memory) {
    if (pointer_to_memory == NULL) {
        return false;
    }
    
    if (osMutexAcquire(g_heap_mutex, MUTEX_TIMEOUT) != osOK) {
        return false;
    }

    free(pointer_to_memory);

    osMutexRelease(g_heap_mutex);

    return true;
}
